# 安装指南

## 前提条件

- Jenkins 2.426.1 或更高版本
- Java 11 或更高版本
- Maven 3.6 或更高版本（从源码构建时需要）

## 安装方法

### 方法一：从 .hpi 文件安装

1. **构建插件**（如果尚未构建）：
   ```bash
   # 在 Windows 上
   build.bat
   
   # 在 Linux/macOS 上
   ./build.sh
   ```

2. **上传到 Jenkins**：
   - 进入 Jenkins 控制台
   - 导航到"系统管理"→"插件管理"
   - 点击"高级设置"选项卡
   - 在"上传插件"部分，点击"选择文件"
   - 从 `target/` 目录选择 `huginn-notify.hpi` 文件
   - 点击"上传"
   - 在提示时重启 Jenkins

### 方法二：开发安装

用于开发和测试：

```bash
mvn hpi:run
```

这将在 `http://localhost:8080/jenkins` 启动一个预安装插件的 Jenkins 实例。

## 安装后配置

### 1. 全局配置

1. 进入"系统管理"→"系统配置"
2. 向下滚动找到"Huginn 通知插件"部分
3. 配置全局设置：
   - **启用全局通知**：勾选以全局启用通知
   - **全局 Webhook URL**：输入您的 Huginn webhook URL
   - **全局 API 密钥**：输入您的 API 密钥（如果需要）
   - **消息语言**：选择首选语言（自动/英文/中文）

### 2. 测试全局配置

- 点击"测试连接"以验证您的 Huginn 设置
- 如果一切配置正确，您应该看到"连接测试成功！"

### 3. 作业级别配置

#### 自由风格作业：
1. 打开您的作业配置
2. 滚动到"构建后操作"部分
3. 点击"增加构建后操作步骤"
4. 选择"Huginn 通知"
5. 配置通知首选项：
   - 覆盖 webhook URL（可选）
   - 覆盖 API 密钥（可选）
   - 选择通知条件（成功、失败、不稳定、已中止）
   - 添加自定义消息模板（可选）

#### 流水线作业：
在流水线脚本中添加 `huginnNotify` 步骤：

```groovy
huginnNotify(
    title: '构建通知',
    message: '项目 ${PROJECT_NAME} 构建${BUILD_RESULT}',
    severity: 'info'
)
```

## 验证

1. **测试配置**：
   - 在配置的作业中运行构建
   - 检查 Jenkins 控制台输出中的通知状态
   - 验证 Huginn 是否接收到 webhook

2. **检查日志**（如果出现问题）：
   - 进入"系统管理"→"系统日志"
   - 寻找与"HuginnNotifyService"相关的条目

## 故障排除

### 常见问题：

1. **连接测试失败**：
   - 验证 webhook URL 是否正确且可访问
   - 如果需要身份验证，请检查 API 密钥
   - 确保 Huginn 实例正在运行且可达

2. **未发送通知**：
   - 检查通知条件是否与构建结果匹配
   - 验证是否配置了 webhook URL（全局或作业级别）
   - 检查 Jenkins 系统日志中的错误消息

3. **变量替换不工作**：
   - 确保正确的变量语法：`${VARIABLE_NAME}`
   - 检查变量在构建上下文中是否可用

4. **构建失败（Java 版本问题）**：
   - 确保使用 Java 11 或兼容版本
   - 在 Windows 上，`build.bat` 脚本会自动设置 Java 路径
   - 手动设置 `JAVA_HOME` 环境变量

### 获取帮助：

- 检查插件文档
- 查看 Jenkins 系统日志
- 验证 Huginn webhook 代理配置
- 首先使用简单消息进行测试

## 卸载

如果需要卸载插件：

1. 进入"系统管理"→"插件管理"
2. 点击"已安装"选项卡
3. 找到"Huginn Notify Plugin"
4. 点击"卸载"
5. 重启 Jenkins

## 更新

要更新到新版本：

1. 构建新版本的插件
2. 进入"系统管理"→"插件管理"
3. 点击"高级设置"选项卡
4. 上传新的 `.hpi` 文件
5. 重启 Jenkins

## 配置备份

建议备份您的配置：

1. **全局配置**：
   - 位于 Jenkins 的 `config.xml` 文件中
   - 包含全局 webhook URL 和 API 密钥设置

2. **作业配置**：
   - 每个作业的 `config.xml` 文件
   - 包含作业特定的通知设置

## 安全注意事项

1. **API 密钥管理**：
   - 使用 Jenkins 凭据存储来管理敏感的 API 密钥
   - 避免在作业配置中硬编码密钥

2. **网络安全**：
   - 确保 webhook URL 使用 HTTPS
   - 验证网络连接的安全性

3. **权限管理**：
   - 限制谁可以配置全局设置
   - 控制作业级别的配置权限

## 下一步

成功安装后：
1. 配置您的 Huginn webhook 代理
2. 为您的作业设置通知规则
3. 根据需要自定义消息模板
4. 测试不同的构建场景

## 支持的操作系统

- Windows 10/11
- Windows Server 2016/2019/2022
- Ubuntu 18.04/20.04/22.04
- CentOS 7/8
- RHEL 7/8
- macOS 10.15+

## 性能考虑

- 插件对 Jenkins 性能的影响最小
- 通知是异步发送的，不会阻塞构建
- 建议监控网络连接到 Huginn 实例的延迟
